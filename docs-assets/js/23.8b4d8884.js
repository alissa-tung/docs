(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{480:function(e,s,n){"use strict";n.r(s);var t=n(10),a=Object(t.a)({},(function(){var e=this,s=e.$createElement,n=e._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"running-on-kubernetes"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#running-on-kubernetes"}},[e._v("#")]),e._v(" Running on Kubernetes")]),e._v(" "),n("p",[e._v("This document describes how to run HStreamDB kubernetes using the specs that we\nprovide. The document assumes basic previous kubernetes knowledge. By the end of\nthis section, you'll have a fully running HStreamDB cluster on kubernetes that's\nready to receive reads/writes, process datas, etc.")]),e._v(" "),n("h2",{attrs:{id:"building-your-kubernetes-cluster"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#building-your-kubernetes-cluster"}},[e._v("#")]),e._v(" Building your Kubernetes Cluster")]),e._v(" "),n("p",[e._v("The first step is to have a running kubernetes cluster. You can use a managed\ncluster (provided by your cloud provider), a self-hosted cluster or a local\nkubernetes cluster using a tool like minikube. Make sure that kubectl points to\nwhatever cluster you're planning to use.")]),e._v(" "),n("p",[e._v("Also, you need a storageClass named "),n("code",[e._v("hstream-store")]),e._v(", you can create by "),n("code",[e._v("kubectl")]),e._v("\nor by your cloud provider web page if it has.")]),e._v(" "),n("h2",{attrs:{id:"install-zookeeper"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#install-zookeeper"}},[e._v("#")]),e._v(" Install Zookeeper")]),e._v(" "),n("p",[e._v("HStreamDB depends on Zookeeper for storing queries information and some internal\nstorage configuration. So we will need to provision a zookeeper ensemble that\nHStreamDB will be able to access. For this demo, we will use\n"),n("a",{attrs:{href:"https://helm.sh/",target:"_blank",rel:"noopener noreferrer"}},[e._v("helm"),n("OutboundLink")],1),e._v(" (A package manager for kubernetes) to install\nzookeeper. After installing helm run:")]),e._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[e._v("helm repo "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("add")]),e._v(" bitnami https://charts.bitnami.com/bitnami\nhelm repo update\n\nhelm "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" zookeeper bitnami/zookeeper "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  --set image.tag"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("3.6")]),e._v(".3 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  --set "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("replicaCount")]),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("3")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  --set persistence.storageClass"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("hstream-store "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  --set persistence.size"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("20Gi\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('NAME: zookeeper\nLAST DEPLOYED: Tue Jul  6 10:51:37 2021\nNAMESPACE: test\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\n** Please be patient while the chart is being deployed **\n\nZooKeeper can be accessed via port 2181 on the following DNS name from within your cluster:\n\n    zookeeper.svc.cluster.local\n\nTo connect to your ZooKeeper server run the following commands:\n\n    export POD_NAME=$(kubectl get pods -l "app.kubernetes.io/name=zookeeper,app.kubernetes.io/instance=zookeeper,app.kubernetes.io/component=zookeeper" -o jsonpath="{.items[0].metadata.name}")\n    kubectl exec -it $POD_NAME -- zkCli.sh\n\nTo connect to your ZooKeeper server from outside the cluster execute the following commands:\n\n    kubectl port-forward svc/zookeeper 2181:2181 &\n    zkCli.sh 127.0.0.1:2181\nWARNING: Rolling tag detected (bitnami/zookeeper:3.6.3), please note that it is strongly recommended to avoid using rolling tags in a production environment.\n+info https://docs.bitnami.com/containers/how-to/understand-rolling-tags-containers/\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br")])]),n("p",[e._v("This will by default install a 3 nodes zookeeper ensemble. Wait until all the\nthree pods are marked as ready:")]),e._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[e._v("kubectl get pods\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("NAME         READY   STATUS    RESTARTS   AGE\nzookeeper-0  1/1     Running   0          22h\nzookeeper-1  1/1     Running   0          4d22h\nzookeeper-2  1/1     Running   0          16m\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br")])]),n("h2",{attrs:{id:"configuring-and-starting-hstreamdb"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#configuring-and-starting-hstreamdb"}},[e._v("#")]),e._v(" Configuring and Starting HStreamDB")]),e._v(" "),n("p",[e._v("Once all the zookeeper pods are ready, we're ready to start installing the\nHStreamDB cluster.")]),e._v(" "),n("h3",{attrs:{id:"fetching-the-k8s-specs"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#fetching-the-k8s-specs"}},[e._v("#")]),e._v(" Fetching The K8s Specs")]),e._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[e._v("git")]),e._v(" clone git@github.com:hstreamdb/hstream.git\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("cd")]),e._v(" hstream/k8s\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br")])]),n("h3",{attrs:{id:"update-configuration"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#update-configuration"}},[e._v("#")]),e._v(" Update Configuration")]),e._v(" "),n("p",[e._v("If you used a different way to install zookeeper, make sure to update the\nzookeeper connection string in storage config file "),n("code",[e._v("config.json")]),e._v(" and server\nservice file "),n("code",[e._v("hstream-server.yaml")]),e._v(".")]),e._v(" "),n("p",[e._v("It should look something like this:")]),e._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[e._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("cat")]),e._v(" config.json "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("grep")]),e._v(" -A "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v(" zookeeper\n  "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v('"zookeeper"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(":")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v('"zookeeper_uri"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(":")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v('"ip://zookeeper-0.zookeeper-headless:2181,zookeeper-1.zookeeper-headless:2181,zookeeper-2.zookeeper-headless:2181"')]),e._v(",\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v('"timeout"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(":")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v('"30s"')]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n$ "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("cat")]),e._v(" hstream-server.yaml "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("grep")]),e._v(" -A "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v(" zkuri\n            - "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v('"--zkuri"')]),e._v("\n            - "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v('"zookeeper-0.zookeeper-headless:2181,zookeeper-1.zookeeper-headless:2181,zookeeper-2.zookeeper-headless:2181"')]),e._v("\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br")])]),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[e._v("TIP")]),e._v(" "),n("p",[e._v("The zookeeper connection string in storage config file and the service file can\nbe different. But for normal scenario, they are the same.")])]),e._v(" "),n("p",[e._v("By default, this spec installs a 3 nodes HStream server cluster and 4 nodes\nstorage cluster. If you want a bigger cluster, modify the "),n("code",[e._v("hstream-server.yaml")]),e._v("\nand "),n("code",[e._v("logdevice-statefulset.yaml")]),e._v(" file, and increase the number of replicas to\nthe number of nodes you want in the cluster. Also by default, we attach a 40GB\npersistent storage to the nodes, if you want more you can change that under the\nvolumeClaimTemplates section.")]),e._v(" "),n("h3",{attrs:{id:"starting-the-cluster"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#starting-the-cluster"}},[e._v("#")]),e._v(" Starting the Cluster")]),e._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[e._v("kubectl apply -k "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(".")]),e._v("\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("p",[e._v("When you run "),n("code",[e._v("kubectl get pods")]),e._v(", you should see something like this:")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("NAME                                                 READY   STATUS    RESTARTS   AGE\nhstream-server-deployment-765c84c489-94nqd           1/1     Running   0          6d18h\nhstream-server-deployment-765c84c489-jrm5p           1/1     Running   0          6d18h\nhstream-server-deployment-765c84c489-jxsjd           1/1     Running   0          6d18h\nlogdevice-0                                          1/1     Running   0          6d18h\nlogdevice-1                                          1/1     Running   0          6d18h\nlogdevice-2                                          1/1     Running   0          6d18h\nlogdevice-3                                          1/1     Running   0          6d18h\nlogdevice-admin-server-deployment-5c5fb9f8fb-27jlk   1/1     Running   0          6d18h\nzookeeper-0                                          1/1     Running   0          6d22h\nzookeeper-1                                          1/1     Running   0          10d\nzookeeper-2                                          1/1     Running   0          6d\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br")])]),n("h3",{attrs:{id:"bootstrapping-the-storage-cluster"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#bootstrapping-the-storage-cluster"}},[e._v("#")]),e._v(" Bootstrapping the Storage Cluster")]),e._v(" "),n("p",[e._v("Once all the logdevice pods are running and ready, you'll need to bootstrap the\ncluster to enable all the nodes. To do that, run:")]),e._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[e._v("kubectl run hstream-admin -it --rm --restart"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("Never --image"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("hstreamdb/hstream:v0.7.1 -- "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n    hadmin store --host logdevice-admin-server-service "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n    nodes-config "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n    bootstrap --metadata-replicate-across "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v("'node:3'")]),e._v("\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br")])]),n("p",[e._v("This will start a hstream-admin pod, that connects to the admin server and\ninvokes the "),n("code",[e._v("nodes-config bootstrap")]),e._v(" hadmin store command and sets the metadata\nreplication property of the cluster to be replicated across three different\nnodes. On success, you should see something like:")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('Successfully bootstrapped the cluster\npod "hstream-admin" deleted\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br")])]),n("h2",{attrs:{id:"managing-the-storage-cluster"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#managing-the-storage-cluster"}},[e._v("#")]),e._v(" Managing the Storage Cluster")]),e._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[e._v("kubectl run hstream-admin -it --rm --restart"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("Never --image"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("hstreamdb/hstream:v0.7.1 -- "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("bash")]),e._v("\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("p",[e._v("Now you can run "),n("code",[e._v("hadmin store")]),e._v(" to manage the cluster:")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("hadmin store --help\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("p",[e._v("To check the state of the cluster, you can then run:")]),e._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[e._v("hadmin store --host logdevice-admin-server-service status\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("+----+-------------+-------+---------------+\n| ID |    NAME     | STATE | HEALTH STATUS |\n+----+-------------+-------+---------------+\n| 0  | logdevice-0 | ALIVE | HEALTHY       |\n| 1  | logdevice-1 | ALIVE | HEALTHY       |\n| 2  | logdevice-2 | ALIVE | HEALTHY       |\n| 3  | logdevice-3 | ALIVE | HEALTHY       |\n+----+-------------+-------+---------------+\nTook 2.567s\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br")])])])}),[],!1,null,null,null);s.default=a.exports}}]);